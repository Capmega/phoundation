#!/usr/bin/php
<?php
/*
 * This is the project deploy script
 * See the help contents for more information
 *
 * @copyright Sven Oostenbrink <support@ingiga.com>, Johan Geuze
 */
$usage = "./scripts/base/deploy ENVIRONMENT / all\n".
         "./scripts/base/deploy\n";

$help  = "The deploy script can deploy the project to target environments, like trial, production, etc.
This is the project deploy script

Possible arguments:

This is the project deploy script





OPTIONS

--all / -a                      - Deploy all sub environments

--ignore-changes / -i           - Ignore git status, don't check for
                                  uncommitted changes

--do-content-check              - Check content files

--do-syntax / --doparse         - Do PHP syntax check parse

--no-deploy / --test            - Do not deploy, only translate

--no-hook / --no-hooks          - Do not execute hooks

--no-init                       - Do not execute an init on the target server

--no-notify                     - Do not send notifications

--no-push                       - Do not automatically git push all changes
                                  and tags

--no-parrallel                  - Do not use parrallel rsync deploy, even if
                                  the website is configured to do so anyway

--no-sitemap                    - Do not automatically reupdate the sitemap
                                  files

--no-tag / --no-tags            - Do not tag current version (tagging is
                                  automatically disabled if doversion has
                                  NOT been set)

--no-translate                  - Do not execute file translation

--no-bom-check                  - Do not test for BOM character in all
                                  PHP files. The ByteOrderMark character is a
                                  UTF8 character (added mostly by apple
                                  machines) that indicates how to read the
                                  UTF8 text, but is interpreted by the PHP as
                                  a character before the <?php tag, which can
                                  cause problems with headers(). The clearbom
                                  script will strip the BOM characters and is
                                  by default always executed on each deploy
                                  to be sure no BOM characters end up in
                                  production code. This option disables the
                                  BOM check.

--stash                         - Execute a \"git stash\" before and \"git
                                  stash pop\" after deploy, in case the WT
                                  contained changes

--up-version / --up-versions    - Update version (Does not do so by default)

--update-content                - rsync the data/content path as well (Normally
                                  always skipped)

--update-sitemap                - rsync the www/LANG/sitemap file as well
                                  (Normally always skipped)

-F --force                      - Force a deploy, even when it should be
                                  stopped due to (for example) git changes

-C --nocolor                    - Do not use color in output

-T --test                       - Do not do anything, just test the flow of
                                  the deploy



HOOK SCRIPTS: Below are shown (in order) the hook scripts that will be
              executed If the hook scripts exist (in ROOT/scripts/hooks)
              they will be executed. If not, they will be ignored

deploy_post_content
deploy_post_syntax
deploy_post_version
deploy_post_tag
deploy_post_push
deploy_post_touch
deploy_pre
deploy_pre_deploy
deploy_post_translation
deploy_post_deploy
deploy_post_permission
deploy_post_init
deploy_post_sitemap
deploy_post_notify
deploy_post_deploy
deploy_post
deploy_finish

Copyright Sven Oostenbrink <support@ingiga.com>, Johan Geuze";

require_once(dirname(__FILE__).'/../../libs/startup.php');

cli_only();
load_libs('init,deploy');

cli_log(tr('Starting deploy of project ":project"', array(':project' => PROJECT)), 'white');

/*
 * Ensure we're not running on the production environment.
 * Deployment is always done to targets, and production is always a target, we cannot deploy from a target to a target
 */
if(ENVIRONMENT == 'production') {
    throw new bException('You are running the deploy script on production environment? Are you high?', 'production');
}

/*
 * Check command line parameters
 */
$noinit         =   cli_argument('--no-init');
$nositemap      =   cli_argument('--no-sitemap');
$nohooks        =  (cli_argument('--no-hook')        or cli_argument('--no-hooks'));
$nosyntax       = !(cli_argument('--do-syntax')      or cli_argument('--do-parse'));
$nodeploy       =  (cli_argument('--no-deploy')      or cli_argument('--test'));
$noversion      = !(cli_argument('--up-version')     or cli_argument('--up-versions'));
$nocontent      = !(cli_argument('--do-content')     or cli_argument('--do-conten-tcheck'));
$nofixperms     =  (cli_argument('--no-fix-perms')   or cli_argument('--no-fix-permissions'));
$nofixstructure =  (cli_argument('--no-fix-struct')  or cli_argument('--no-fix-structure'));
$all            =  (cli_argument('--all')            or cli_argument('-a'));
$ignore         =  (cli_argument('--ignore-changes') or cli_argument('-i'));
$nocacheclear   =   cli_argument('--no-cache-clear');
$notranslate    =   cli_argument('--no-translate');
$ignore_php     =   cli_argument('--ignore-php');
$ignore_html    =   cli_argument('--ignore-html');

$update_content =   cli_argument('--update-content');
$update_sitemap =   cli_argument('--update-sitemap');

$notag          =  (cli_argument('--no-tag')        or cli_argument('--no-tags') or $noversion);
$nopush         =   cli_argument('--no-push');
$stash          =   cli_argument('--stash');
$notouch        =   cli_argument('--no-touch');

$nocompress     =   cli_argument('--no-compress');
$forcecompress  =   cli_argument('--force-compress');
$noparrallel    =   cli_argument('--no-parrallel');
$nonotify       =   cli_argument('nonotify');

$message        =   cli_argument('--message'       , true);
$continuersync  =   cli_argument('--continuer-sync', true);
$categories     =   cli_argument('--category'      , 'all', cli_argument('--categories', 'all'));
$nobomcheck     =   cli_argument('--no-bom-check');

$tilde          = '~'.date('Ymd-His');
$targets        =   cli_arguments();

cli_no_arguments_left();

if(!$message and !$notag){
    throw new bException(tr('No tag message specified! please use ./scripts/base/deploy ..... message "commit message"'), 'not-specified');
}



/*
 * Load deployment configuration
 */
include(ROOT.'config/deploy.php');

if(empty($_CONFIG['deploy'])){
    throw new bException(tr('No deploy configuration found'), 'config');
}



/*
 * Check target configuration availability
 */
if(!$targets){
    if(!$categories){
        throw new bException(tr('No target environment or environment categories specified!'), 'not-specified');
    }

    /*
     * If we're going to deploy to production categories, ensure that we
     * either are on master or production branch, since we won't deploy
     * from any other branch (for safety)
     */
    if(in_array('production', $categories)){
        load_libs('git');
        $branch = git_branch();

        if($branch != 'production'){
            if(!FORCE){
                throw new bException(tr('Cannot deploy the current GIT branch ":branch" to production category. For safety, deployment to production environment is restricted to git "production" branch only', array(':branch' => $branch)), 'productioninvalidbranch');
            }

            /*
             * Notify about forced deploy!
             */
            notify('deploy', tr('DEPLOY WARNING! NON PRODUCTION BRANCH DEPLOYED TO PRODUCTION: Deployed branch ":branch" to production category for project ":project"', array(':branch' => $branch, ':project' => PROJECT)));
        }
    }

    /*
     * Get the targets from the specified categories
     */
    foreach(array_force($categories) as $category){
        foreach($_CONFIG['deploy'] as $target => $deploy){
            if(isset_get($deploy['categories']) == $category){
                $targets[] = $target;
            }
        }
    }

    if(empty($targets)){
        throw new bException(tr('The specified categories ":categories" contain no deploy targets', array(':categories' => str_force($categories, ', '))), 'empty');
    }
}

if(count($targets) == 1){
    $targets = array_pop($targets);
}

if($targets === true){
    /*
     * "./scripts/base/deploy all" was used
     */
    $targets = 'all';
}

if($targets == 'all'){
    /*
     * Get all deployment targets
     */
    $targets = array_keys($_CONFIG['deploy']);
    cli_log(tr('Deploying to ALL target environments ":targets"', array(':targets' => $targets)), 'yellow');

}elseif(is_array($targets)){
    cli_log(tr('Deploying to specified target environments ":targets"', array(':targets' => str_force($targets, ', '))), 'yellow');

}else{
    cli_log(tr('Deploying to specified target environment ":target"', array(':target' => str_force($targets))), 'yellow');
    $targets = array($targets);
}

if(!$targets){
    throw new bException('No deployment targets specified', 'not-specified');
}



/*
 * Check if we dont have any changes that should be committed first
 */
if(!$ignore){
    if(!trim(shell_exec('git status | grep "nothing to commit" | wc -l'))) {
        if(!FORCE){
            if(!$stash){
                throw new bException('Git commit pending', 'COMMITFIRST');
            }

            cli_log(tr('Changes detected, git stashing changes before comming'), 'yellow');
            safe_exec('git stash');
        }

    }else{
        $stash = false;
    }
}



/*
 * If we're going to deploy to production environment, ensure that we
 * either are on master or production branch, since we won't deploy
 * from any other branch (for safety)
 */
if(in_array('production', $targets)){
    load_libs('git');
    $branch = git_branch();

    if($branch != 'production'){
        if(!FORCE){
            throw new bException(tr('Cannot deploy the current GIT branch ":branch" to production environment. For safety, deployment to production environment is restricted to git "production" branch only', array(':branch' => $branch)), 'productioninvalidbranch');
        }

        /*
         * Notify about forced deploy!
         */
        notify('deploy', tr('DEPLOY WARNING! NON PRODUCTION BRANCH DEPLOYED TO PRODUCTION: Deployed branch ":branch" to production environment for project ":project"', array(':branch' => $branch, ':project' => PROJECT)));
    }
}



/*
 * Do project BOM check
 */
if($nobomcheck){
    cli_log(tr('Skipping BOM check due to "--no-bom-check" option'), 'yellow');

}else{
    cli_log(tr('Executing BOM check'), 'white');
    script_exec('base/clearbom');
}



/*
 * Do a PHP syntax check on the entire project
 */
if($nosyntax){
    cli_log(tr('Skipping PHP syntax check due to no "--do-syntax" command line parameter'), 'yellow');

}else{
    cli_log(tr('Executing PHP syntax check'), 'white');

    exec('find . -type f -name "*.php"', $output);

    if(!is_array($output)){
        throw new bException('Syntax check failed', 'production');
    }

    if(!$output){
        throw new bException('No php files found.', 'production');
    }

    foreach($output as $file){
        if(substr($file, 0, 7) == './data/'){
            /*
             * Do not check PHP files in ROOT/data
             */
            continue;
        }

        exec('php -l '.ROOT.$file.' > /dev/null', $syntaxoutput, $return);

        if($return){
            throw new bException(tr('Content scan failed on file ":file" with ":error"', array(':file' => $file, ':error' => $syntaxoutput)), 'production');
        }

        cli_dot();
    }

    cli_dot(false);
    init_hook('deploy_post_content', $nohooks, array('exitcode' => $return));

}



/*
 * Do a project version revision upgrade
 */
if($noversion){
    cli_log(tr('Skipping PHP version update due to no "--do-version" command line parameter'), 'yellow');

}else{
    cli_log(tr('Executing PHP version update'), 'white');

    /*
     * Get version data
     */
    $oldversion = PROJECTCODEVERSION;
    $newversion = init_version_upgrade($oldversion, 'revision');

    /*
     * Update project configuration file
     */
    $data = file_get_contents(ROOT.'config/project.php');
    $data = preg_replace('/\''.$oldversion.'\'\);/', '\''.$newversion.'\');', $data);

    file_put_contents(ROOT.'config/project.php', $data);

    exec('cd '.ROOT.'; git add config/project.php; git commit -m "Upgraded project \"'.PROJECT.'\" version to \"'.$newversion.'\""');

    init_hook('deploy_post_version', $nohooks, array('oldversion' => $oldversion,
                                                     'newversion' => $newversion));

}



/*
 * Do system tag with the new version
 */
if($noversion or $notag){
    cli_log(tr('Skipping git version tagging due to either no "--do-version" or no "--do-tag" command line parameters'), 'yellow');

}else{
    cli_log(tr('Executing git version tagging'), 'white');

    passthru('cd '.ROOT.'; git tag -am "['.PROJECT.' / '.$newversion.'] '.$message.'" '.$newversion.';', $exitcode);

    if($exitcode){
        throw new bException('Git tagging failed with exit code "'.str_log($exitcode).'"', 'git_tag');
    }

    init_hook('deploy_post_tag', $nohooks, array('exitcode' => $exitcode));
}



/*
 * Do git push all changes and tags
 */
if($nopush){
    cli_log(tr('Skipping git push for changes and tags due to no "--do-version" or no "--do-tag" or no "--do-push" command line parameters'), 'yellow');

}else{
    cli_log(tr('Executing git push'), 'white');

    /*
     * Get current branch
     */
    $branch = trim(shell_exec('git rev-parse --abbrev-ref HEAD'));

    passthru('cd '.ROOT.'; git push origin '.$branch.' && git push origin '.$branch.' --tags', $exitcode);

    if($exitcode){
        throw new bException('Git push failed with exit code "'.str_log($exitcode).'"', 'git_push');
    }

    init_hook('deploy_post_push', $nohooks, array('exitcode' => $exitcode));
}



/*
 * If version was upgraded, execute an init to avoid leaving the dev site inoperable
 */
if(!$noversion){
    cli_log(tr('Project version revision was updated, executing init script to update project database'), 'white');
    passthru(ROOT.'script/base/init -E '.$target_environment, $exitcode);

    if($exitcode){
        throw new bException('System init failed with exit code "'.str_log($exitcode).'"', 'local_init');
    }
}



/*
 * Run compress script
 */
if($nocompress){
    cli_log(tr('Skipping file compress due to "--no-compress" command line parameter'), 'yellow');

}else{
    cli_log(tr('Executing file compress script'), 'white');

    $option = '';

    if($forcecompress){
        /*
         * Compress script should be run with -f option
         */
        cli_log(tr('Executing file compress script with force mode'), 'white');
        $option = ' -f';
    }

    try{
        script_exec('base/compress', $option);

    }catch(Exception $e){
        throw new bException('script_exec(): Failed to execute "'.str_log('base/compress').'"', $e);
    }

    /*
     * Compress script generates files that aren't git commited
     * so we must do a git commit for those files.
     */
    if(!trim(shell_exec('git status | grep "nothing to commit" | wc -l'))){
        cli_log(tr('Changes detected from the compression script script, committing to git'), 'white');
        safe_exec('cd '.ROOT.'; git add .');
        safe_exec('git commit -m "Deploy commit: compressed files changed"');

        if(!$nopush){
            passthru('cd '.ROOT.'; git push && git push --tags', $exitcode);
        }
    }
}



/*
 * Do code translation
 */
if($notranslate){
    cli_log(tr('Skipping translations due to "--no-translate" option'), 'yellow');

}else{
    cli_log(tr('Executing translations'), 'white');

    if($_CONFIG['language']['supported']){
        $options[] = 'translate';

        if($ignore_php){
            $options[] = '--ignore-php';
        }

        if($ignore_html){
            $options[] = '--ignore-html';
        }

        script_exec('base/translate', $options);
        init_hook('deploy_post_translation', $nohooks, array('languages' => $_CONFIG['language']['supported']));
    }
}



/*
 * Update the mtime of the entire project tree to ensure caching wont happen and the webserver will send out the new files
 */
if($notouch){
    cli_log(tr('Skipping touch mtime update due to no "--no-touch" command line parameters'), 'yellow');

}else{
    cli_log(tr('Executing touch on entire project tree updating all mtimes'), 'white');

    passthru('cd '.ROOT.'; find . -exec touch {} \;', $exitcode);

    if($exitcode){
        throw new bException('Touch failed with exit code ":code"', array(':code' => $exitcode), 'git_push');
    }

    init_hook('deploy_post_touch', $nohooks, array('exitcode' => $exitcode));
}



foreach($targets as $target_environment){
    if(!preg_match('/^[a-z0-9]+$/', $target_environment)){
        throw new bException('Invalid target environment name "'.str_log($target_environment).'" specified, can only contain alphanumeric characters', 'unknown');
    }

    if(empty($_CONFIG['deploy'][$target_environment])){
        throw new bException('Unknown target environment "'.str_log($target_environment).'" specified', 'unknown');
    }

    /*
     * Ensure that target environment configuration file is available.
     */
    if(!file_exists(ROOT.'config/'.$target_environment.'.php')){
        throw new bException('Target environment "'.str_log($target_environment).'" has no configuration file', 'missingfile');
    }

    $deploy_config               = $_CONFIG['deploy'][$target_environment];
    $deploy_config['target_dir'] = unslash($deploy_config['target_dir']);

    if(!$deploy_config['target_user']){
        /*
         * No target user specified, use the current process user
         */
        $deploy_config['target_user'] = get_current_user();
    }

    cli_log(tr('Deploying to target environment ":target"', array(':target' => $target_environment)), 'white');

    init_hook('deploy_pre', $nohooks, array('target_user'   => $deploy_config['target_user'],
                                            'target_port'   => $deploy_config['target_port'],
                                            'target_server' => $deploy_config['target_server'],
                                            'target_dir'    => $deploy_config['target_dir']));



    /*
     * Determine SUDO setup for this environment
     */
    $sudo        = '';
    $sudo_user   = '';
    $target_port = isset_get($deploy_config['target_port'], 22);

    if($deploy_config['sudo']){
        if($deploy_config['sudo'] === true){
            $sudo      = 'export SHELL=/bin/bash; sudo -s ';
            $sudo_user = 'export SHELL=/bin/bash; sudo -s ';

        }elseif(is_string($deploy_config['sudo'])){
            $sudo      = 'export SHELL=/bin/bash; sudo -s ';
            $sudo_user = 'export SHELL=/bin/bash; sudo -s -u '.$deploy_config['sudo'].' ';

        }else{
            throw new bException('Invalid sudo configuration ":configuration" found for target environment ":target". It should be either true, false, or an (existing) username string', array(':configuration' => $deploy_config['sudo'], ':target' => $target_environment));
        }
    }



    /*
     * Do a content file check on the entire project
     */
    if($nocontent){
        cli_log(tr('Skipping content file check due to "--no-content" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing content file check'), 'white');

        exec('grep load_content  www scripts -R', $output);

        if(!is_array($output)){
            throw new bException('Content scan failed', 'production');
        }

        if(!$output){
            throw new bException('No "load_content" found which is impossible, because the system library has it.', 'production');
        }

        /*
         * Extract a list of unique files
         */
        $files = array();

        foreach($output as $line){
            if(preg_match('/(.*?):.*?load_content\s*\(\s*\'(.*?)\'\s*,/i', $line, $matches)){
                /*
                 * Skip function definitions, comments, etc.
                 */
                if(empty($matches[2])){
                    /*
                     * Not a valid match, skip
                     */
                    continue;
                }

                $files[$matches[2]] = $matches[1];
            }
        }

        /*
         * Ensure content file availability
         */
        foreach($files as $file => $definedin){
            if(substr($definedin, 0, 14) == 'scripts/tests/'){
                continue;
            }

            if($_CONFIG['language']['supported']){
                foreach($_CONFIG['language']['supported'] as $language){
                    cli_log(tr('Searching for file ":file" on ":target"', array(':file' => $file, ':target' => $deploy_config['target_server'])));

                    exec('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'ls '.($file = $deploy_config['target_dir'].'data/content/'.$language.'/'.$file.'.html').' 2>&1 /dev/null\'', $contentoutput, $return);

                    if($return){
                        throw new bException('Missing content file "'.str_log($file).'" for language "'.str_log($language).'", defined in "'.$definedin.'"', 'production');
                    }
                }
            }
        }

        init_hook('deploy_post_syntax', $nohooks, array('exitcode' => $return));
    }



    /*
     * Load environment specific configuration and override current config
     */
    cli_log(tr('Starting deploy on ":date"', array(':date' => date('d M Y h:i'))), 'white');

    init_hook('deploy_pre_deploy', $nohooks, array('target_user'    => $deploy_config['target_user'],
                                                   'target_port'    => $deploy_config['target_port'],
                                                   'target_server'  => $deploy_config['target_server'],
                                                   'target_dir'     => $deploy_config['target_dir']));



    /*
     * In case of rsync_parrallel option, copy the target dir and use the copy for the rsync and file permissions update
     */
    if($noparrallel){
        cli_log(tr('Deploying in non rsync parrallel mode due to "--no-parrallel" option'), 'yellow');
        $deploy_config['rsync_parrallel'] = false;
    }


    /*
     * Continue rsyncing a previously stopped deploy?
     */
    if($continuersync){
        if(!$deploy_config['rsync_parrallel']){
            throw new bException(tr('The continuersync option was specified which makes no sense when either the project does not support rsync_parrallel, or when rsync_parrallel has been disabled because of the command line option "noparrallel"'), 'invalid');
        }

        /*
         * Validate $continuersync value
         */
        while(!preg_match('/^20\d{6}-\d{6}$/', $continuersync)){
            if(!preg_match('/^'.str_rfrom($deploy_config['target_dir'], '/').'~20\d{6}-\d{6}\/?$/', $continuersync)){
                throw new bException(tr('The specified continuersync option "'.str_log($continuersync).'" is invalid, it should be in the Ymd-His format, or targetpath~Ymd-His'), 'invalid');
            }

            $continuersync = str_until(str_from($continuersync, '~'), '/');
        }
    }


    if(!empty($deploy_config['rsync_parrallel'])){
        /*
         * Make a copy on the server, rsync that copy, then move that copy in place of the current version. This will cause less down time due to version differences
         */
        cli_log(tr('Deploying in rsync to parrallel mode'), 'white');

        if($continuersync){
            /*
             * Search for existing copies
             */
            if(count(safe_exec('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'ls '.($deploy_config['target_dir']).'~'.$continuersync.' 2> /dev/null \'', 2)) < 2){
                /*
                 * Does not exist
                 */
                throw new bException(tr('The specified continuesync path "'.str_log(($deploy_config['target_dir']).'~'.$continuersync).'" on the target environment "'.str_log($target_environment).'" does not exist'), '');
            }

            $tilde = '~'.$continuersync;
            cli_log(tr('Continuing with specified copy ":copy" of current version', array(':copy' => $deploy_config['target_dir'].$tilde)), 'white');

        }else{
            cli_log(tr('Creating copy of current version to ":target"', array(':target' => $deploy_config['target_dir'].$tilde)), 'white');

            /*
             * Does the project exist at all? or is it an initial deploy?
             */
            passthru('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'ls '.$deploy_config['target_dir'].'\' > /dev/null 2>&1', $exitcode);

            if($exitcode){
                /*
                 * Doesn't exist!
                 */
                passthru('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'mkdir '.$deploy_config['target_dir'].'\'', $exitcode);
            }

            passthru('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'rm '.$deploy_config['target_dir'].$tilde.' -rf; '.$sudo.'cp -a '.$deploy_config['target_dir'].' '.$deploy_config['target_dir'].$tilde.'\'', $exitcode);

            if($exitcode){
                throw new bException('rsync_parrallel copy failed with exit code "'.str_log($exitcode).'"', 'rsync_parrallel');
            }
        }

        $deploy_config['target_dir'] .= $tilde;
    }



    /*
     * Do the deploy
     */
    if($nodeploy){
        cli_log(tr('NOT deploying, due to "--no-deploy" or "--test" command line parameter'), 'yellow');

    }else{
        $exclude = ' --exclude=*~ --exclude="data/mocks" --exclude="data/mock*" --exclude="data/uploads" --exclude="data/packages" --exclude=".git*" --exclude="/data/system"  --exclude="/data/tmp" ';

        if(!$update_content){
            $exclude .= ' --exclude="data/content" ';
        }

        foreach($_CONFIG['language']['supported'] as $code => $language){
            if(!$update_sitemap){
                $exclude .= ' --exclude="www'.$language.'sitemap.html*" --exclude="www'.$language.'sitemap.xml*" --exclude="www'.$language.'mock" ';
            }

            $exclude = ' --exclude="www'.$language.'sitemap.html*" --exclude="www'.$language.'sitemap.xml*" --exclude="www'.$language.'mock" ';
        }

        if(count($deploy_config['exclude_dirs'])) {
            foreach($deploy_config['exclude_dirs'] as $key => $dir) {
                $exclude .= ' --exclude="'.$dir.'" ';
            }
        }

        cli_log(tr('Deploying project to target server ":server" on path ":path"', array(':server' => $deploy_config['target_server'], ':path' => $deploy_config['target_dir'])), 'white');
        passthru('rsync -aczvAXHS --progress -p --delete '.($deploy_config['sudo'] ? '--rsync-path="sudo rsync" ' : '').'-e "ssh -p '.$deploy_config['target_port'].'" '.ROOT.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].':'.$deploy_config['target_dir'].' '.$exclude, $exitcode);
        exec('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'mkdir -p '.$deploy_config['target_dir'].'/data/system 2> /dev/null; '.$sudo.'touch '.$deploy_config['target_dir'].'/data/system/last_deploy\'', $contentoutput, $return);

        if($exitcode){
            throw new bException('Rsync failed with exit code "'.str_log($exitcode).'"', 'rsync');
        }

        init_hook('deploy_post_deploy', $nohooks, array('target_user'    => $deploy_config['target_user'],
                                                        'target_port'    => $deploy_config['target_port'],
                                                        'target_server'  => $deploy_config['target_server'],
                                                        'target_dir'     => $deploy_config['target_dir']));
    }



    /*
     * Fix structure
     */
    if($nofixstructure){
        cli_log(tr('Skipping structure fix due to "--no-fix-structure" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing structure fix'), 'white');

        if(!empty($deploy_config['rsync_parrallel'])){
            passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.$deploy_config['target_dir'].'/scripts/base/fix-structure -E '.$target_environment.' \'', $exitcode);

        }else{
            passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.$deploy_config['target_dir'].'/scripts/base/fix-structure -E '.$target_environment.' \'', $exitcode);
        }

        if($exitcode){
            throw new bException('fix-permissions failed with exit code "'.str_log($exitcode).'"', 'fix-permissions');
        }

        init_hook('deploy_post_permission', $nohooks, array('target_user'   => $deploy_config['target_user'],
                                                            'target_port'   => $deploy_config['target_port'],
                                                            'target_server' => $deploy_config['target_server'],
                                                            'target_dir'    => $deploy_config['target_dir']));
    }



    /*
     * Fix permissions
     */
    if($nofixperms){
        cli_log(tr('Skipping file permission fix due to "--no-fix-permissions" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing file permission fix'), 'white');

        if(!empty($deploy_config['rsync_parrallel'])){
            passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.$deploy_config['target_dir'].'/scripts/base/fix-permissions -E '.$target_environment.' \'', $exitcode);

        }else{
            passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.$deploy_config['target_dir'].'/scripts/base/fix-permissions -E '.$target_environment.' \'', $exitcode);
        }

        if($exitcode){
            throw new bException('fix-permissions failed with exit code "'.str_log($exitcode).'"', 'fix-permissions');
        }

        init_hook('deploy_post_permission', $nohooks, array('target_user'   => $deploy_config['target_user'],
                                                            'target_port'   => $deploy_config['target_port'],
                                                            'target_server' => $deploy_config['target_server'],
                                                            'target_dir'    => $deploy_config['target_dir']));
    }



    /*
     * From here, the target directory should be normal again
     */
    $deploy_config['target_dir'] = str_until($deploy_config['target_dir'], '~');



    /*
     * In case of rsync_parrallel option, move the copy back in place, and remove the original
     */
    if(!empty($deploy_config['rsync_parrallel'])){
        cli_log(tr('Moving new version in place'), 'white');
        passthru('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'mv '.$deploy_config['target_dir'].' '.$deploy_config['target_dir'].$tilde.'_old; '.$sudo.'mv '.$deploy_config['target_dir'].$tilde.' '.$deploy_config['target_dir'].'\'', $exitcode);

        if($exitcode){
            throw new bException('Moving new version in place failed with exit code "'.str_log($exitcode).'"', 'rsync_parrallel_move');
        }

        cli_log(tr('Deleting old version'), 'white');
        passthru('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.'rm '.$deploy_config['target_dir'].$tilde.'_old -rf\'', $exitcode);

        if($exitcode){
            throw new bException('Deleting old version in place failed with exit code "'.str_log($exitcode).'"', 'rsync_parrallel_delete');
        }
    }



    /*
     * Execute init on target
     */
    if($noinit){
        cli_log(tr('Skipping target init due to "--no-init" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing init on target server with environment ":env"', array(':env' => $target_environment)), 'white');
        passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.$deploy_config['target_dir'].'/scripts/base/init -E '.$target_environment.' \'', $exitcode);

        if($exitcode){
            throw new bException('Target version init failed with exit code "'.str_log($exitcode).'"', 'target_init');
        }

        init_hook('deploy_post_init', $nohooks, array('target_user'     => $deploy_config['target_user'],
                                                      'target_port'     => $deploy_config['target_port'],
                                                      'target_server'   => $deploy_config['target_server'],
                                                      'target_dir'      => $deploy_config['target_dir']));
    }



    /*
     * Auto rebuild the sitemap?
     */
    if($nositemap){
        cli_log(tr('Skipping auto sitemap deploy due to "--no-sitemap" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing sitemap scan and deploy on target server'), 'white');

        passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo_user.$deploy_config['target_dir'].'/scripts/base/sitemap scan -E '.$target_environment.' \'', $exitcode);

        if($exitcode){
            throw new bException('Target sitemap scan failed with exit code "'.str_log($exitcode).'"', 'target_sitemap_scan');
        }

        if($_CONFIG['language']['supported']){
            foreach($_CONFIG['language']['supported'] as $language){
                passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo_user.$deploy_config['target_dir'].'/scripts/base/sitemap deploy   html '.$language.' -E '.$target_environment.' \'', $exitcode);

                if($exitcode){
                    throw new bException('Target sitemap HTML build failed with exit code "'.str_log($exitcode).'"', 'target_sitemap_html');
                }

                passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo_user.$deploy_config['target_dir'].'/scripts/base/sitemap deploy    xml '.$language.' -E '.$target_environment.' \'', $exitcode);

                if($exitcode){
                    throw new bException('Target sitemap XML build failed with exit code "'.str_log($exitcode).'"', 'target_sitemap_xml');
                }

                passthru($command = 'ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo_user.$deploy_config['target_dir'].'/scripts/base/sitemap deploy robots '.$language.' -E '.$target_environment.' \'', $exitcode);

                if($exitcode){
                    throw new bException('Target sitemap robots build failed with exit code "'.str_log($exitcode).'"', 'target_sitemap_robots');
                }
            }
        }

        init_hook('deploy_post_sitemap', $nohooks, array('exitcode' => $exitcode));
    }

    /*
     * Send notifications
     */
    if($nonotify){
        cli_log(tr('Skipping deploy notifications due to "--no-notify" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing deploy notifications'), 'white');

        notify('deploy', 'Deployed project "'.PROJECT.'" with languages "'.str_log(implode(', ', array_force($_CONFIG['language']['supported']))).'"');

        init_hook('deploy_post_notify', $nohooks, array('target_user'   => $deploy_config['target_user'],
                                                        'target_port'   => $deploy_config['target_port'],
                                                        'target_server' => $deploy_config['target_server'],
                                                        'target_dir'    => $deploy_config['target_dir']));
    }

    /*
     * Cache clear
     */
    if($nocacheclear){
        cli_log(tr('Skipping cache clear due to "--no-cache-clear" command line parameter'), 'yellow');

    }else{
        cli_log(tr('Executing cache clear'), 'white');

        passthru('ssh -t -p '.$target_port.' '.$deploy_config['target_user'].'@'.$deploy_config['target_server'].' \''.$sudo.$deploy_config['target_dir'].'/scripts/base/cache clear -E '.$target_environment.'\'', $exitcode);

        if($exitcode){
            throw new bException('Cache clear failed with exit code "'.str_log($exitcode).'"', 'cache clear');
        }
    }

    if($stash){
        cli_log(tr('Git stashed changes detected, unstashing'), 'yellow');
        safe_exec('git stash pop');
    }


    /*
     * Done!
     */
    cli_log(tr('Finished deploy for project ":project" environment ":env"', array(':project' => PROJECT, ':env' => $target_environment)), 'green');

    init_hook('post_deploy', $nohooks, array('target_user'   => $deploy_config['target_user'],
                                             'target_port'   => $deploy_config['target_port'],
                                             'target_server' => $deploy_config['target_server'],
                                             'target_dir'    => $deploy_config['target_dir']));
}


/*
 * We're all done here!
 */
cli_log(tr('Finished deploy sequence'), 'green');
init_hook('deploy_finish', $nohooks, array('target_user'    => $deploy_config['target_user'],
                                           'target_port'    => $deploy_config['target_port'],
                                           'target_server'  => $deploy_config['target_server'],
                                           'target_dir'     => $deploy_config['target_dir']));
?>
