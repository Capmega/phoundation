#!/usr/bin/php
<?php
/*
 * This script can be used to import geo data from the geodata project
 */
$usage   = './scripts/base/importers/geo
./scripts/base/importers/geo clear
./scripts/base/importers/geo download
./scripts/base/importers/geo load-data [username USERNAME] [password PASSWORD] [database DATABASE]
./scripts/base/importers/geo fix-data
./scripts/base/importers/geo import countries&|states&|counties&|cities | all country (COUNTRY,COUNTRYCODE,etc...)
./scripts/base/importers/geo fix-errors';

$help    = 'The geo importer script can import geo data like countries, states, counties and cities from the geoname database repository



METHODS



clear



download                        - Will download the geoname data files from the
                                  geonames website

    --no-check-certificate      - When using https://, do not check the SSL
                                  certificates

    --no-ssl                    - Force use of http:// over https://



load-data                       -



fix-data                        -



import                          -

    --no-counties               -



fix-errors                      - ';

require_once(__DIR__.'/../../../libs/startup.php');
cli_exclusive();
cli_only();



$_CONFIG['db']['core']['pdo_attributes'] = array(PDO::ATTR_EMULATE_PREPARES  => true,
                                                 PDO::ATTR_STRINGIFY_FETCHES => true);



/*
 * Get some optional data required for loaddata
 */
$username     = cli_argument('-u,--user,--username', true, 'base');
$password     = cli_argument('-p,--pass,--password', true, 'base');
$database     = cli_argument('-d,--database'       , true, 'geonames');
$skipcounties = cli_argument('--no-counties');



/*
 * Import related data
 */
$threshold = cli_argument('threshold', true, 100);

switch(cli_method()){
    case 'clear':
        switch(cli_method(1)){
            case 'geonames':
                log_console(tr('Clearing all data from "geonames" database'), 'white');

                sql_query('SET autocommit         = 1;');
                sql_query('SET unique_checks      = 1;');
                sql_query('SET foreign_key_checks = 1;');

                log_console(tr('Clearing cities'));
                sql_query('DELETE FROM geo_cities;');

                log_console(tr('Clearing counties'));
                sql_query('DELETE FROM geo_counties;');

                log_console(tr('Clearing states'));
                sql_query('DELETE FROM geo_states;');

                if(cli_argument('all')){
                    log_console(tr('Clearing countries'));
                    sql_query('DELETE FROM geo_countries;');

                    log_console(tr('Clearing continents'));
                    sql_query('DELETE FROM geo_continents;');
                }

                break;

            case 'geotables':
                log_console(tr('Clearing all data from ":database" database, geo_* tabkes', array(':database' => $_CONFIG['db']['core']['db'])), 'white');

                sql_query('DELETE FROM `geo_cities`');
                sql_query('DELETE FROM `geo_counties`');
                sql_query('DELETE FROM `geo_states`');
                sql_query('DELETE FROM `geo_countries`');
                sql_query('DELETE FROM `geo_timezones`');
                break;

            case '':
                throw new bException('No "clear" sub method specified. Please specify one of "geonames", or "geotables"', 'not-specified');

            default:
                throw new bException(tr('Unknown "clear" sub method ":method" specified. Please specify one of "geonames", or "geotables"', array(':method' => cli_method())), 'unknown');
        }

        break;

    case 'download':
        load_libs('file');

        log_console(tr('DOWNLOAD'), 'white');
        log_console(tr('Deleting old data...'));

        $no_check_certificate = cli_argument('--no-check-certificate');
        $no_ssl               = cli_argument('--no-ssl');

        /*
         * Get the global data path where the geonames data is stored
         */
        $geoimport_path = get_global_data_path('geonames');
        $files          = array('allCountries',
                                'admin1CodesASCII',
                                'admin2Codes',
                                'allCountries',
                                'alternateNames',
                                'countryInfo',
                                'featureCodes_en',
                                'hierarchy',
                                'iso-languagecodes',
                                'timeZones');

        foreach($files as $file){
            file_delete($geoimport_path.$file.'*');
        }

        if($no_check_certificate){
            if($no_ssl){
                throw new bException(tr('The --no-check-certificate and --no-ssl options are mutually exclusive. Please choose one or the other'), 'invalid');
            }

            /*
             * Change the wget commands in geonames_importer.sh to not check SSL certificates
             */
            $data = file_get_contents($geoimport_path.'geonames_importer.sh');
            $data = str_replace('wget http', 'wget --no-check-certificate http', $data);

            file_put_contents($geoimport_path.'geonames_importer.sh', $data);

        }else{
            /*
             * Change the wget commands in geonames_importer.sh to check SSL certificates
             */
            $data = file_get_contents($geoimport_path.'geonames_importer.sh');
            $data = str_replace('wget --no-check-certificate http', 'wget http', $data);

            file_put_contents($geoimport_path.'geonames_importer.sh', $data);

            if($no_ssl){
                /*
                 * Change the wget commands in geonames_importer.sh to check SSL certificates
                 */
                $data = file_get_contents($geoimport_path.'geonames_importer.sh');
                $data = str_replace('wget https', 'wget http', $data);

                file_put_contents($geoimport_path.'geonames_importer.sh', $data);
            }
        }

        log_console(tr('Downloading data, this may take a while...'));
        $result = passthru('cd '.$geoimport_path.'; '.$geoimport_path.'geonames_importer.sh -a download-data', $exitcode);

        if($exitcode){
            throw new bException(tr('Data download failed'), 'failed');
        }

        break;

    case 'load-data':
        log_console(tr('LOADDATA'), 'white');

        /*
         * Get the global data path where the geonames data is stored
         */
        $geoimport_path = get_global_data_path('geonames');

        if(!$username or !$password){
            throw new bException('No user name and / or password specified', 'not-specified');
        }

        /*
         * Fix geonames_importer.sh
         *
         * geonames_importer.sh SHOWS THE FUCKING PASSWORD ON SCREEN..
         * Now inline passwords used here are not 100% ideal, they are still
         * visible in the process list, but to display it on screen is a bit much
         *
         * Also, in case of error, its returning exit code 0 which does not work very
         * nice
         */
        $data = file_get_contents($geoimport_path.'geonames_importer.sh');
        $data = str_replace('echo "Password: "', '#echo "Password: "', $data);
        $data = str_replace('echo "[FAILED]"', 'echo "[GEONAMES_IMPORTER FAILED]"; exit 1', $data);

        file_put_contents($geoimport_path.'geonames_importer.sh', $data);

        /*
         * Fix geonames_db_struct.sql
         *
         * geonames_db_struct.sql creates tables using CHARSET UTF8. This should be utf8mb4
         */
        $data = file_get_contents($geoimport_path.'geonames_db_struct.sql');
        $data = str_replace('utf8;'   , 'utf8mb4;', $data);
        $data = str_replace('utf8mb4;', 'utf8mb4 COLLATE="utf8mb4_unicode_ci";', $data);

        file_put_contents($geoimport_path.'geonames_db_struct.sql', $data);

        /*
         * Fix geonames_db_struct.sql
         *
         * geonames_db_struct.sql creates tables using CHARSET UTF8. This should be utf8mb4
         */
        $data = file_get_contents($geoimport_path.'geonames_import_data.sql');
        $data = str_replace('CHARACTER SET \'UTF8\'' , 'CHARACTER SET \'UTF8MB4\'', $data);

        file_put_contents($geoimport_path.'geonames_import_data.sql', $data);

        /*
         * Due to a fucked up MySQL "security feature" that does not allow LOAD DATA LOCAL INFILE
         * but MAY allow LOAD DATA INFILE (which requires the file to be in /var/lib/mysql), we
         * need to modify the ./geonames_import_data.sql file a little.
         *
         * IF this is the situation, the import would fail with the rather cryptic message
         * "ERROR 1148 (42000) at line 1: The used command is not allowed with this MySQL version"
         *
         * Use the "notlocal" command line option to overcome this problem, but DO NOTE! Root
         * rights are required for this since a symlink in /var/lib/mysql is required.
         *
         * See data/doc/geo.txt for more information
         */
        if(cli_argument('notlocal')){
            log_console(tr('Updating geonames_import_data.sql for non local import'), 'yellow');

            $uniqid = uniqid();
            $data   = file_get_contents($geoimport_path.'geonames_import_data.sql');
            $data   = str_replace('LOAD DATA LOCAL INFILE ', 'LOAD DATA INFILE'   , $data);
            $data   = str_replace('LOAD DATA INFILE \'./'  , 'LOAD DATA INFILE \'', $data);
            $data   = str_replace('LOAD DATA INFILE \''    , 'LOAD DATA INFILE \''.$uniqid.'/', $data);

            file_put_contents($geoimport_path.'geonames_import_data.sql', $data);
            symlink($geoimport_path, '/var/lib/mysql/'.$uniqid);
        }

        try{
            passthru('cd '.$geoimport_path.' ; ./geonames_importer.sh -a create-db -u '.$username.' -p "'.$password.'" -n "'.$database.'"', $exitcode);

            if($exitcode){
                throw new bException(tr('Creating geonames database failed'), 'failed');
            }

            passthru('cd '.$geoimport_path.' ; ./geonames_importer.sh -a import-dumps -u '.$username.' -p "'.$password.'" -n "'.$database.'"', $exitcode);

            if($exitcode){
                throw new bException(tr('Importing data dumps to geonames database failed'), 'failed');
            }

        }catch(Exception $e){
            throw new bException('Import failed. In case of "The used command is not allowed with this MySQL version" error, please try the "notlocal" command line option, see geo.txt documentation for more information', $e);
        }

        if(cli_argument('notlocal')){
            /*
             * Remove dat symlink
             */
            unlink('/var/lib/mysql/'.$uniqid);
        }

        break;

    case 'fix-data':
        log_console(tr('FIXDATA'), 'white');

        $geosql = new PDO('mysql:dbname='.$database.';host=localhost', $username, $password);
        $geosql->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        $geosql->query('USE `'.$database.'`;');
        $geosql->query('SET NAMES '.$_CONFIG['db']['core']['charset']);
        $geosql->query('SET CHARACTER SET '.$_CONFIG['db']['core']['charset']);

        $r = $geosql->query('SHOW TABLES LIKE "geonames"');

        if(!$r->rowCount()){
            log_console(tr('Renaming geonames table'));
            $geosql->query('RENAME TABLE `geoname` TO `geonames`;');
        }

        $r = $geosql->query('SHOW COLUMNS FROM `geonames` WHERE `Field` = "parents_id"');

        if(!$r->rowCount()){
            log_console(tr('Adding parents_id to geonames table'));
            $geosql->query('ALTER TABLE `geonames` ADD COLUMN `parents_id` INT(11) AFTER `geonameid`;');
        }

        log_console(tr('Applying hierarchy'));

        $r     = $geosql->query('SELECT * FROM `hierarchy` ORDER BY `type`;');
        $p     = $geosql->prepare('UPDATE `geonames` SET `parents_id` = :parents_id WHERE `geonameid` = :childs_id');
        $count = 0;

        while($row = $r->fetch(PDO::FETCH_ASSOC)){
            cli_dot(1000);
            $p->execute(array(':parents_id' => $row['parentId'],
                              ':childs_id'  => $row['childId']));
        }

        cli_dot(false);
        log_console(tr('Applying indices'), 'white');

        foreach(array('geonameid', 'parents_id', 'name', 'country', 'admin1', 'admin2', 'moddate', 'latitude', 'longitude') as $column){
            $geosql->query('ALTER TABLE `geonames` ADD INDEX (`'.$column.'`);');
            log_console(tr('Applied index for ":column"', array(':column' => $column)), 'green');
        }

        cli_dot(false);

        ///*
        // * Remove double entries
        // */
// :TODO: Implement
        //$geosql->query('SELECT geonameid, name, country, latitude, longiture, moddate FROM geonames GROUPBY name, latitude, longitude HAVING COUNT(*) > 1');

        break;

    case 'import':
        if(!$country_list = cli_argument('country', true)){
            throw new bException('No country list specified to import data from. Please specify "country COUNTRY,COUNTRY,COUNTRY"', 'not-specified');
        }

        $country_list = explode(',', $country_list);

        foreach($country_list as &$country){
            $country = strtolower(mb_trim($country));
        }

        unset($country);

        $geosql = new PDO('mysql:dbname='.$database.';host=localhost', $username, $password);
        $geosql->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        $geosql->query('USE '.$database.';');
        $geosql->query('SET NAMES '.$_CONFIG['db']['core']['charset']);
        $geosql->query('SET CHARACTER SET '.$_CONFIG['db']['core']['charset']);

        load_libs('seo');

        $types['all']        =  cli_argument('all');
        $types['continents'] = (cli_argument('continents') or $types['all']);
        $types['regions']    = (cli_argument('regions')    or $types['all']);
        $types['countries']  = (cli_argument('countries')  or $types['all']);
        $types['states']     = (cli_argument('states')     or $types['all']);
        $types['counties']   = (cli_argument('counties')   or $types['all']);
        $types['cities']     = (cli_argument('cities')     or $types['all']);

        log_console(tr('Caching timezone data...'));
        $timezones = sql_list('SELECT `code`, `id` FROM geo_timezones;');

        sql_query('SET autocommit         = 0;');
        sql_query('SET unique_checks      = 0;');
        sql_query('SET foreign_key_checks = 0;');

        /*
         * Import continents?
         */
        if($types['continents']){

            log_console(tr('Clearing old continents...'));
            sql_query('DELETE FROM `geo_continents`');

            log_console(tr('Importing continents...'));
            $r = $geosql->query('SELECT * FROM `continentCodes`');

            while($row = $r->fetch(PDO::FETCH_ASSOC)){
                $geonamedata = $geosql->query('SELECT * FROM `geonames` WHERE `geonameid` = '.cfi($row['geonameid'], false));
                $geonamedata = $geonamedata->fetch(PDO::FETCH_ASSOC);

                sql_query('INSERT INTO `geo_continents`(`geonames_id`, `timezones_id`, `code`, `name`, `seoname`, `alternate_names`, `latitude`, `longitude`, `moddate`)
                           VALUES                      (:geonames_id , :timezones_id , :code , :name , :seoname , :alternate_names , :latitude , :longitude , :moddate)',

                           array(':geonames_id'          => $row['geonameid'],
                                 ':timezones_id'         => isset_get($timezones[$geonamedata['timezone']]),
                                 ':code'                 => $row['code'],
                                 ':name'                 => $row['name'],
                                 ':seoname'              => seo_unique_string($row['name'], 'geo_continents'),
                                 ':alternate_names'      => $geonamedata['alternatenames'],
                                 ':latitude'             => $geonamedata['latitude'],
                                 ':longitude'            => $geonamedata['longitude'],
                                 ':timezones_id'         => isset_get($timezones[$geonamedata['timezone']]),
                                 ':moddate'              => $geonamedata['moddate']));
            }

            sql_query('COMMIT;');
        }

        /*
         * Cache the continents list
         */
        log_console(tr('Caching continents...'));

        $continents = sql_list('SELECT `code`, `id` FROM geo_continents');

        /*
         * Import countries?
         */
        if($types['countries']){
            log_console(tr('Importing countries...'));
            $r = $geosql->query('SELECT * FROM `countryinfo`');

            $country_exists_statement = sql_prepare('SELECT `id`
                                                     FROM   `geo_countries`
                                                     WHERE  `geonames_id` = :geonames_id
                                                     OR     `code`        = :code
                                                     OR     `name`        = :name');

            while($row = $r->fetch(PDO::FETCH_ASSOC)){
                $geonamedata = $geosql->query('SELECT * FROM `geonames` WHERE `geonameid` = '.cfi($row['geonameId'], false));
                $geonamedata = $geonamedata->fetch(PDO::FETCH_ASSOC);

                $country_exists_statement->execute(array(':geonames_id' => $row['geonameId'], ':code' => $row['iso_alpha2'], 'name' => $row['name']));

                if($country_exists_statement->rowCount()){
                    log_console(tr('The country ":country" already exists and will be skipped', array(':country' => $row['name'])), 'yellow');
                    continue;
                }

                sql_query('INSERT INTO `geo_countries` (`geonames_id`, `continents_id`, `timezones_id`, `code`, `iso_alpha2`, `iso_alpha3`, `iso_numeric`, `fips_code`, `tld`, `name`, `seoname`, `equivalent_fips_code`, `neighbours`, `languages`, `postal_code_regex`, `postal_code_format`, `phone`, `currency`, `currency_name`, `population`, `areainsqkm`, `capital`, `latitude`, `longitude`, `alternate_names`, `moddate`)
                           VALUES                      (:geonames_id , :continents_id , :timezones_id , :code , :iso_alpha2 , :iso_alpha3 , :iso_numeric , :fips_code , :tld , :name , :seoname , :equivalent_fips_code , :neighbours , :languages , :postal_code_regex , :postal_code_format , :phone , :currency , :currency_name , :population , :areainsqkm , :capital , :latitude , :longitude , :alternate_names , :moddate )',

                           array(':geonames_id'          => $row['geonameId'],
                                 ':continents_id'        => isset_get($continents[$row['continent']]),
                                 ':timezones_id'         => isset_get($timezones[$geonamedata['timezone']]),
                                 ':code'                 => $row['iso_alpha2'],
                                 ':iso_alpha2'           => $row['iso_alpha2'],
                                 ':iso_alpha3'           => $row['iso_alpha3'],
                                 ':iso_numeric'          => $row['iso_numeric'],
                                 ':fips_code'            => $row['fips_code'],
                                 ':tld'                  => $row['tld'],
                                 ':name'                 => $row['name'],
                                 ':seoname'              => seo_unique_string($row['name'], 'geo_countries'),
                                 ':equivalent_fips_code' => $row['equivalentFipsCode'],
                                 ':neighbours'           => $row['neighbours'],
                                 ':languages'            => $row['languages'],
                                 ':postal_code_regex'    => $row['postalCodeRegex'],
                                 ':postal_code_format'   => $row['postalCodeFormat'],
                                 ':phone'                => $row['Phone'],
                                 ':currency'             => $row['currency'],
                                 ':currency_name'        => $row['currencyName'],
                                 ':population'           => $row['population'],
                                 ':areainsqkm'           => $row['areainsqkm'],
                                 ':capital'              => $row['capital'],
                                 ':latitude'             => $geonamedata['latitude'],
                                 ':longitude'            => $geonamedata['longitude'],
                                 ':alternate_names'      => $geonamedata['alternatenames'],
                                 ':moddate'              => $geonamedata['moddate']));
            }

            sql_query('COMMIT;');
        }

        if(in_array('all', $country_list)){
            /*
             * Import all countries
             */
            log_console(tr('Importing for all countries. Please be patient, this may take a while!!'), 'yellow');
            $countries = sql_list('SELECT `id` FROM `geo_countries`');

        }else{
            /*
             * Import only for the specified countries
             */
            log_console(tr('ONLY ADDING FOR THESE COUNTRIES:'), 'yellow');

            foreach(array_force($country_list) as $country){
                if(strtolower($country) == 'all'){

                }else{
                    if(!$result = sql_get('SELECT `id`, `name` FROM `geo_countries` WHERE `name` = :name OR `seoname` = :seoname or `code` = :code', array('name' => $country, 'seoname' => $country, 'code' => $country))){
                        throw new bException('Specified country "'.str_log($country).'" not found');
                    }

                    log_console($result['name'], 'yellow');
                    $countries[] = $result['id'];
                }
            }
        }

        /*
         * Now import for all countries
         */
        foreach($countries as $country){
            /*
             * Import states?
             */
            if(!$types['states']){
                log_console(tr('Not importing states...'), 'yellow');

            }else{
                log_console(tr('Importing states...'));
                log_console(tr('Buffering countries...'));

                $countries      = sql_list('SELECT `id`,
                                                   `geonames_id`,
                                                   `name`,
                                                   `seoname`,
                                                   `code`

                                            FROM   `geo_countries`'.($country ? '

                                            WHERE  `id` = '.$country : ''));
                $country_idlist = array();

                foreach($countries as $id => $country){
                    $country_idlist[] = $id;
                }

// :DELETE: Delete following 2 lines. States will no longer be deleted. Before insert, a check will be done if the state already exists, and if so, it will be skipped
                //log_console('Clearing old states...');
                //sql_query('DELETE FROM `geo_states` WHERE `countries_id` IN ('.str_force($country_idlist).');');
                $state_exists_statement = sql_prepare('SELECT `id`

                                                       FROM   `geo_states`

                                                       WHERE  `geonames_id`  = :geonames_id
                                                       OR    (`countries_id` = :countries_id
                                                       AND    `name`         = :name)');


                foreach($countries as $id => $country_data){
                    /*
                     * If United States of America, then fix "New England Region" crap
                     */
                    if(strtolower(trim($country_data['code'])) == 'us'){
                        $parents_id = sql_fetch($geosql->query('SELECT `geonameid` FROM `geonames` WHERE `fcode` = "ZN" AND `name` = "New England Region"'), 'geonameid');
                        $geosql->query('UPDATE `geonames` SET `parents_id` = '.$country_data['geonames_id'].' WHERE `parents_id` = '.$parents_id);
                    }

                    log_console(tr('Importing states for country "'.$country_data['name'].'"...'));
                    $r = $geosql->query('SELECT * FROM `geonames` WHERE `parents_id` = '.cfi($country_data['geonames_id'], false));

                    while($row = $r->fetch(PDO::FETCH_ASSOC)){
                        $state_exists_statement->execute(array(':geonames_id' => $row['geonameid'], ':countries_id' => $id, 'name' => $row['name']));

                        if($state_exists_statement->rowCount()){
                            log_console(tr('The state ":state" in country ":country" already exists and will be skipped', array(':state' => $row['name'], ':country' => $country_data['name'])), 'yellow');
                            continue;
                        }

                        sql_query('INSERT INTO `geo_states`(`geonames_id`, `countries_id`, `country_code`, `timezones_id`, `code`, `name`, `seoname`, `alternate_names`, `latitude`, `longitude`, `population`, `elevation`, `admin1`, `admin2`, `moddate`)
                                   VALUES                  (:geonames_id , :countries_id , :country_code , :timezones_id , :code , :name , :seoname , :alternate_names , :latitude , :longitude , :population , :elevation , :admin1 , :admin2 , :moddate )',

                                   array(':geonames_id'     => $row['geonameid'],
                                         ':countries_id'    => $id,
                                         ':country_code'    => $country_data['code'],
                                         ':timezones_id'    => isset_get($timezones[$row['timezone']]),
                                         ':code'            => (is_numeric($row['admin1']) ? '' : $row['admin1']),
                                         ':name'            => $row['name'],
                                         ':seoname'         => seo_unique_string($row['name'], 'geo_states'),
                                         ':alternate_names' => $row['alternatenames'],
                                         ':latitude'        => $row['latitude'],
                                         ':longitude'       => $row['longitude'],
                                         ':population'      => $row['population'],
                                         ':elevation'       => $row['elevation'],
                                         ':admin1'          => $row['admin1'],
                                         ':admin2'          => $row['admin2'],
                                         ':moddate'         => $row['moddate']));
                    }
                }

                sql_query('COMMIT;');
            }

            /*
             * Import counties?
             */
            if(!$types['counties'] or $skipcounties){
                log_console(tr('Not importing counties...'), 'yellow');

            }else{
// :DELETE: Delete following 2 lines. Counties will no longer be deleted. Before insert, a check will be done if the county already exists, and if so, it will be skipped
                //log_console('Clearing old counties...');
                //sql_query('DELETE FROM `geo_counties`');

                log_console(tr('Importing counties...'));

                $county_exists_statement = sql_prepare('SELECT  `id`
                                                        FROM    `geo_counties`
                                                        WHERE   `geonames_id` = :geonames_id
                                                        OR     (`states_id`   = :states_id
                                                            AND `name`        = :name)');

                if(empty($countries)){
                    log_console(tr('Buffering countries...'));
                    $countries = sql_list('SELECT `id`,
                                                  `geonames_id`,
                                                  `name`,
                                                  `seoname`,
                                                  `code`,
                                                  `admin1`,
                                                  `admin2`

                                           FROM   `geo_countries`'.($country ? '

                                           WHERE  `id` = '.$country : ''));
                }

                foreach($countries as $countries_id => $country_data){
                    if(empty($states[$country_data['seoname']])){
                        $states[$country_data['seoname']] = sql_list('SELECT `id`,
                                                                             `geonames_id`,
                                                                             `name`,
                                                                             `seoname`,
                                                                             `code`,
                                                                             `admin1`,
                                                                             `admin2`

                                                                      FROM `geo_states`

                                                                      WHERE `countries_id` = '.$countries_id);
                    }

                    foreach($states[$country_data['seoname']] as $states_id => $state_data){
                        log_console(tr('Importing counties for state ":state" for country ":country"...', array(':state' => $state_data['name'], ':country' => $country_data['name'])));

                        $r = $geosql->query('SELECT *

                                             FROM   `geonames`

                                             WHERE  `parents_id` = '.cfi($state_data['geonames_id'], false).'
                                             AND    `fclass`     = "A"');

                        if(!$r->rowCount()){
                            /*
                             * Looks like this state has no counties specified, just states > cities
                             */
                            log_console(tr('Looks like state ":state" does not have counties, skipping', array(':state' => $state_data['name'])), 'yellow');
                            continue;
                        }

                        while($row = $r->fetch(PDO::FETCH_ASSOC)){
                            $county_exists_statement->execute(array(':geonames_id' => $row['geonameid'], ':states_id' => $states_id, 'name' => $row['name']));

                            if($county_exists_statement->rowCount()){
                                log_console(tr('The county ":county" in country ":country" already exists and will be skipped', array(':county' => $row['name'], ':country' => $country_data['name'])), 'yellow');
                                continue;
                            }

                            sql_query('INSERT INTO `geo_counties`(`geonames_id`, `countries_id`, `states_id`, `timezones_id`, `code`, `name`, `seoname`, `alternate_names`, `latitude`, `longitude`, `population`, `elevation`, `admin1`, `admin2`, `moddate`)
                                       VALUES                    (:geonames_id , :countries_id , :states_id , :timezones_id , :code , :name , :seoname , :alternate_names , :latitude , :longitude , :population , :elevation , :admin1 , :admin2 , :moddate )',

                                       array(':geonames_id'     => $row['geonameid'],
                                             ':countries_id'    => $countries_id,
                                             ':states_id'       => $states_id,
                                             ':timezones_id'    => isset_get($timezones[$row['timezone']]),
                                             ':code'            => $row['cc2'],
                                             ':name'            => $row['name'],
                                             ':seoname'         => seo_unique_string($row['name'], 'geo_counties'),
                                             ':alternate_names' => $row['alternatenames'],
                                             ':latitude'        => $row['latitude'],
                                             ':longitude'       => $row['longitude'],
                                             ':population'      => $row['population'],
                                             ':elevation'       => $row['elevation'],
                                             ':admin1'          => $row['admin1'],
                                             ':admin2'          => $row['admin2'],
                                             ':moddate'         => $row['moddate']));
                        }
                    }
                }

                sql_query('COMMIT;');
            }

            /*
             * Import cities?
             */
            if(!$types['cities']){
                log_console(tr('Not importing cities...'), 'yellow');

            }else{
// :DELETE: Delete following 2 lines. Cities will no longer be deleted. Before insert, a check will be done if the city already exists, and if so, it will be skipped
                //log_console(tr('Clearing old cities...'));
                //sql_query('DELETE FROM `geo_cities`');

                log_console(tr('Importing cities...'));

                if(empty($countries)){
                    log_console(tr('Buffering countries...'));
                    $countries = sql_list('SELECT `id`,
                                                  `geonames_id`,
                                                  `name`,
                                                  `seoname`,
                                                  `code`

                                           FROM   `geo_countries`'.($country ? '

                                           WHERE  `id` = '.$country : ''));
                }

                $city_exists_statement = sql_prepare('SELECT `geonames_id`,
                                                             `name`,
                                                             `moddate`

                                                      FROM   `geo_cities`

                                                      WHERE (`name`      = :name
                                                      AND    `states_id` = :states_id)
                                                      OR    (`name`      = :name
                                                      AND    `latitude`  = :latitude
                                                      AND    `longitude` = :longitude)');

                /*
                 * Add cities for all countries
                 */
                foreach($countries as $countries_id => $country_data){
                    log_console(tr('Buffering states for country ":country"...', array(':country' => $country_data['name'])));
                    $states[$country_data['seoname']] = sql_list('SELECT `id`,
                                                                         `geonames_id`,
                                                                         `name`,
                                                                         `seoname`,
                                                                         `code`,
                                                                         `admin1`,
                                                                         `admin2`

                                                                  FROM   `geo_states`

                                                                  WHERE  `countries_id` = '.$countries_id);

                    unset($usecounties);

                    /*
                     * Add cities for all states
                     */
                    foreach($states[$country_data['seoname']] as $states_id => $state_data){
                        log_console(tr('Buffering counties for state ":state" of country ":country"...', array(':state' => $state_data['name'], ':country' => $country_data['name'])));
                        $counties[$country_data['seoname']][$state_data['seoname']] = sql_list('SELECT `id`, `geonames_id`, `name`, `seoname`, `code`, `admin1`, `admin2` FROM `geo_counties` WHERE `states_id` = '.$states_id);

                        /*
                         * Search for cities within counties. If no cities are found in any county, this means that s
                         */
                        if(!isset($usecounties)){
                            if(empty($counties[$country_data['seoname']][$state_data['seoname']])){
                                log_console(tr('State ":state" has no counties, assuming no counties for country ":country"', array(':state' => $state_data['name'], ':country' => $country_data['name'])), 'yellow');
                                $usecounties = false;

                            }else{
                                log_console(tr('Counting cities in state and counties (Some geonames countries have missing counties - cities links)'));

                                $state_cities_count  = $geosql->query('SELECT COUNT(*) AS `count`

                                                                       FROM   `geonames`

                                                                       WHERE  `country`     = "'.$country_data['code'].'"

                                                                       AND   (`fcode`       IN ("PPL", "PPLA", "PPLA2", "PPLA3", "PPLA4", "ISL"))

                                                                       AND    `admin1`      = "'.$state_data['admin1'].'"
                                                                       AND    `population`  > 0');

                                $state_cities_count  = $state_cities_count->fetch(PDO::FETCH_ASSOC);
                                $state_cities_count  = $state_cities_count['count'];

                                $county_cities_count = 0;

                                $r_search = $geosql->prepare('SELECT COUNT(*) AS `count`

                                                              FROM   `geonames`

                                                              WHERE  `country`     = :country
                                                              AND   (`fcode`       IN ("PPL", "PPLA", "PPLA2", "PPLA3", "PPLA4", "ISL"))
                                                              AND    `admin1`      = :admin1
                                                              AND    `admin2`      = :admin2
                                                              AND    `population`  > 0');

                                /*
                                 * Count the cities for all counties together, they should match the cities for the state
                                 */
                                foreach($counties[$country_data['seoname']][$state_data['seoname']] as $counties_id => $county_data){
                                    $r_search->execute(array(':country' => $country_data['code'],
                                                             ':admin1'  => $county_data['admin1'],
                                                             ':admin2'  => $county_data['admin2']));

                                    $count = $r_search->fetch(PDO::FETCH_ASSOC);

                                    $county_cities_count += $count['count'];
                                }

                                if($state_cities_count == $county_cities_count){
                                    /*
                                     * Okay, we found cities for a county, we can presume that all counties are then okay.
                                     */
                                    $usecounties = (true and $skipcounties);
                                    log_console(tr('Cities per county match cities per state, using counties - cities links'), 'white');

                                }else{
                                    $usecounties = false;
                                    log_console(tr('Cities per county does NOT match cities per state, NOT using counties - cities links'), 'yellow');
                                }
                            }
                        }

                        if(!$usecounties){
                            log_console(tr('Adding cities without counties - cities links'));

                            /*
                             * This state has no counties
                             */
                            $r = $geosql->query('SELECT *

                                                 FROM   `geonames`

                                                 WHERE  `country`     = "'.$country_data['code'].'"
                                                 AND   (`fcode`       IN ("PPL", "PPLA", "PPLA2", "PPLA3", "PPLA4", "ISL"))
                                                 AND    `admin1`      = "'.$state_data['admin1'].'"
                                                 AND    `population`  > '.cfi($threshold, false));

                            log_console(tr('Importing cities for state ":state" for country ":country"...', array(':state' => $state_data['name'], ':country' => $country_data['name'])));

                            while($row = $r->fetch(PDO::FETCH_ASSOC)){
                                $city_exists_statement->execute(array(':name'      => $row['name'],
                                                                      ':states_id' => $states_id,
                                                                      ':latitude'  => $row['latitude'],
                                                                      ':longitude' => $row['longitude']));

                                if($city_exists_statement->rowCount()){
                                    /*
                                     * This city already exists. Only update this if its newer
                                     */
                                    $databasedate = $city_exists_statement->fetch(PDO::FETCH_ASSOC);
                                    $databasedate = new DateTime($databasedate['moddate']);
                                    $newdate      = new DateTime($row['moddate']);

                                    if($newdate > $databasedate){
// :TODO: Update the city instead of adding.
                                    }else{
                                        log_console(tr('City ":city" in state ":state" in country ":country" already exists, skipping', array(':city' => $row['name'], ':state' => $state_data['name'], ':country' => $country_data['name'])), 'yellow');
                                    }

                                }else{
                                    sql_query('INSERT INTO `geo_cities` (`is_city`, `geonames_id`, `countries_id`, `country_code`, `states_id`, `timezones_id`, `timezone`, `name`, `seoname`, `alternate_names`, `latitude`, `longitude`, `population`, `elevation`, `admin1`, `admin2`, `feature_code`, `moddate`)
                                               VALUES                   (true     , :geonames_id , :countries_id , :country_code , :states_id , :timezones_id , :timezone , :name , :seoname , :alternate_names , :latitude , :longitude , :population , :elevation , :admin1 , :admin2 , :feature_code , :moddate )',

                                               array(':geonames_id'     => $row['geonameid'],
                                                     ':countries_id'    => $countries_id,
                                                     ':country_code'    => $country_data['code'],
                                                     ':states_id'       => $states_id,
                                                     ':timezone'        => $row['timezone'],
                                                     ':timezones_id'    => isset_get($timezones[$row['timezone']]),
                                                     ':name'            => $row['name'],
                                                     ':seoname'         => seo_unique_string(array('seoname'   => $row['name'],
                                                                                                   'states_id' => $states_id), 'geo_cities'),
                                                     ':alternate_names' => $row['alternatenames'],
                                                     ':latitude'        => $row['latitude'],
                                                     ':longitude'       => $row['longitude'],
                                                     ':population'      => $row['population'],
                                                     ':elevation'       => $row['elevation'],
                                                     ':feature_code'    => $row['fcode'],
                                                     ':admin1'          => $row['admin1'],
                                                     ':admin2'          => $row['admin2'],
                                                     ':moddate'         => $row['moddate']));
                                }

                                sql_query('COMMIT;');
                            }

                        }else{
                            log_console(tr('Adding citied with counties - cities links'));

                            /*
                             * Add all cities for this county
                             */
                            foreach($counties[$country_data['seoname']][$state_data['seoname']] as $counties_id => $county_data){
                                log_console(tr('Importing cities for county ":county" for state ":state" for country ":country"...', array(':county' => $county_data['name'], ':state' => $state_data['name'], ':country' => $country_data['name'])));

                                /*
                                 * Search for all cities
                                 */
                                $r = $geosql->query('SELECT *

                                                     FROM   `geonames`

                                                     WHERE  `country`     = "'.$country_data['code'].'"
                                                     AND   (`fcode`       IN ("PPL", "PPLA", "PPLA2", "PPLA3", "PPLA4", "ISL"))
                                                     AND    `admin1`      = "'.$county_data['admin1'].'"
                                                     AND    `admin2`      = "'.$county_data['admin2'].'"
                                                     AND    `population`  > '.cfi($threshold, false));

                                while($row = $r->fetch(PDO::FETCH_ASSOC)){
                                    $city_exists_statement->execute(array(':name'      => $row['name'],
                                                                          ':states_id' => $row['states_id'],
                                                                          ':latitude'  => $row['latitude'],
                                                                          ':longitude' => $row['longitude']));

                                    if($city_exists_statement->rowCount()){
                                        /*
                                         * This city already exists. Only update this if its newer
                                         */
                                        $databasedate = $city_exists_statement->fetch(PDO::FETCH_ASSOC);
                                        $databasedate = new DateTime($databasedate['moddate']);
                                        $newdate      = new DateTime($row['moddate']);

                                        if($newdate > $databasedate){
// :TODO: Update the city instead of adding.
                                        }else{
                                            log_console(tr('City ":city" in state ":state" in country ":country" already exists, skipping', array(':city' => $row['name'], ':state' => $state_data['name'], ':country' => $country_data['name'])), 'yellow');
                                        }

                                    }else{
                                        sql_query('INSERT INTO `geo_cities` (`is_city`, `geonames_id`, `countries_id`, `country_code`, `states_id`, `counties_id`, `timezones_id`, `timezone`, `name`, `seoname`, `alternate_names`, `latitude`, `longitude`, `population`, `elevation`, `admin1`, `admin2`, `feature_code`, `moddate`)
                                                   VALUES                   (true     , :geonames_id , :countries_id , :country_code , :states_id , :counties_id , :timezones_id , :timezone , :name , :seoname , :alternate_names , :latitude , :longitude , :population , :elevation , :admin1 , :admin2 , :feature_code , :moddate )',

                                                   array(':geonames_id'     => $row['geonameid'],
                                                         ':countries_id'    => $countries_id,
                                                         ':country_code'    => $country_data['code'],
                                                         ':states_id'       => $states_id,
                                                         ':counties_id'     => $counties_id,
                                                         ':timezone'        => $row['timezone'],
                                                         ':timezones_id'    => isset_get($timezones[$row['timezone']]),
                                                         ':name'            => $row['name'],
                                                         ':seoname'         => seo_unique_string(array('seoname'   => $row['name'],
                                                                                                       'states_id' => $states_id), 'geo_cities'),
                                                         ':alternate_names' => $row['alternatenames'],
                                                         ':latitude'        => $row['latitude'],
                                                         ':longitude'       => $row['longitude'],
                                                         ':population'      => $row['population'],
                                                         ':elevation'       => $row['elevation'],
                                                         ':feature_code'    => $row['fcode'],
                                                         ':admin1'          => $row['admin1'],
                                                         ':admin2'          => $row['admin2'],
                                                         ':moddate'         => $row['moddate']));
                                    }
                                }
                            }
                        }
                    }
                }

                sql_query('COMMIT;');
            }
        }

        break;

    case 'fix-errors':
        /*
         * Fix possible
         */
        $states = sql_query('SELECT `id`, `geonames_id`, `admin1` FROM `geo_states`');
        $update = sql_prepare('UPDATE `geo_states` SET `code` = :code WHERE `id` = :id');

        log_console(tr('Fixing geo_states missing state codes'));
        sql_query('UPDATE `geo_states` SET `code` = ""');

        while($state = sql_fetch($states)){
            if(!is_numeric($state['admin1'])){
                $update->execute(array(':id'   => $state['id'],
                                       ':code' => $state['admin1']));
            }

            cli_dot(1);
        }

        cli_dot(false);
        break;

    case '':
        throw new bException('No method specified. Please specify one of "clear", "download", "load-data", "fix-data", "fix-errors", "import"', 'not-specified');

    default:
        throw new bException(tr('Unknown  method ":method" specified. Please specify one of "clear", "download", "load-data", "fix-data", "fix-errors", "import"', array(':method' => cli_method())), 'unknown');
}

sql_query('SET autocommit         = 1;');
sql_query('SET unique_checks      = 1;');
sql_query('SET foreign_key_checks = 1;');

log_console(tr('DONE!'), 'green');
?>
