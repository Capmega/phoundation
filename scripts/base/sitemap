#!/usr/bin/php
<?php
/*
 * This script creates sitemap files for all languages
 *
 * Idea taken from http://yoast.com/xml-sitemap-php-script/
 * Written by Sven Oostenbrink
 *
 * Copyright (C), 2011 - 2012 - Sven Oostenbrink, so.oostenbrink@gmail.com
 */
$usage = "sitemap list\n".
         "sitemap build\n".
         "sitemap show html|xml|txt LANGUAGECODE\n".
         "sitemap install html|xml|txt LANGUAGECODE";

$help  = "The sitemap script can create sitemaps in various formats. It has two modes, build and generate. Build mode (\"build\" argument) will scan the www/LANGUAGE/ directory for accessible files, and store these in the database. The generate mode (\"html\", \"xml\", and \"txt\" will generate the sitemap files in the required format and place them in the www/LANGUAGE/ dir for each available or specified language";

require_once(dirname(__FILE__).'/../../libs/startup.php');

try{
    cli_basic_arguments();

    load_libs('sitemap');

    right_or_redirect('admin');

    switch(argument(0)){
        case 'build':
            log_error('Building sitemap', 'start', 'white');
            sitemap_build();
            log_error('Done!', 'finished', 'green');
            break;

        case 'install':
            // FALLTHROUGH
        case 'show':
            /*
             * Install or show sitemap file
             */
            if(!argument(2)){
                /*
                 * No language code specified
                 */
                throw new bException('No language code specified', 'notspecified');
            }

            $languages = strtolower(argument(2));

            if((strlen($languages) != 2) and ($languages != 'all')){
                /*
                 * Invalid language code specified
                 */
                throw new bException('Invalid language code "'.str_log(argument(2)).'" specified. A valid language code has only 2 letters', 'invalid');
            }

            if(!isset($_CONFIG['language']['supported'][$languages])){
                /*
                 * Specified language not supported
                 */
                throw new bException('The specified language code "'.str_log(argument(2)).'" does not exist', 'notexist');
            }

            if($languages == 'all'){
                if(!$_CONFIG['sitemap']['languages']){
                    /*
                     * The sitemap supported languages are not specified, so use all supported system languages
                     */
                    $languages = array_keys($_CONFIG['language']['supported']);

                }else{
                    $languages = $_CONFIG['sitemap']['languages'];
                }

            }else{
                $languages = array($languages);
            }

            /*
             * Now perform the action for each language
             */
            foreach($languages as $language){
                $params = array('language' => $language);

                if(argument(0) == 'install'){
                    /*
                     * To install the file, the sitemap generate functions cannot send headers themselves and die,
                     * they have to return the data so that it can be placed in the file here
                     */
                    $return    = true;
                    $extension = argument(1);

                }else{
                    $return    = false;
                }

                switch(argument(1)){
                    case 'html':
                        $data = sitemap_html($params, $return);
                        break;

                    case 'xml':
                        $data = sitemap_xml($params, $return);
                        break;

                    case 'txt':
                        $data = sitemap_txt($params, $return);
                        break;
                }

                if(argument(0) == 'install'){
                    file_put_contents(ROOT.'www/'.$language.'/sitemap.'.$extension, $data);
                    log_console('Installed sitemap.'.str_log($extension).' for language "'.str_log($language).'"', 'installed', 'green');
                }
            }

            break;

        case 'list':
            log_console('Date                  Status     Createdby    Language', '', 'white');

            $r = sql_query('SELECT `id`, `createdon`, `createdby`, `status`, `language` FROM `sitemap_builds`');

            while($build = sql_fetch($r)){
                $date = new DateTime($build['createdon']);

                log_console($date->format('Y-m-d H:i:s').'   '.str_size(status($build['status']), 9).'  '.str_size(user_name($build['createdby']), 9).'    '.str_size(isset_get($_CONFIG['language']['supported'][$build['language']], 'Unknown'), 15), '');
            }

            break;

        case '':
            throw new bException('No argument specified', 'unknown');

        default:
            throw new bException('Unknown argument "'.str_log(argument(0)).'" specified', 'unknown');
    }

}catch(Exception $e){
    cli_error('scripts/base/sitemap: Failed', $e);
}
?>
